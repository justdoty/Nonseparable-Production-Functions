\documentclass{article}
\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{dcolumn}
\usepackage{array}
\usepackage{mathtools}
\usepackage{float}
\usepackage{booktabs}
\usepackage{cleveref}
\usepackage{siunitx}
\usepackage{enumitem}
\usepackage{bbm}
\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{float}
\usepackage{natbib}
\newtheorem{assump}{Assumption}[section]
\newtheorem{lemma}{Lemma}[section]
\usepackage[toc,page]{appendix}
\pagenumbering{gobble}
\topmargin 0.0cm
\oddsidemargin 0.2cm
\textwidth 16cm
\textheight 21cm
\footskip 1.0cm
\title{A Dynamic Panel Data Framework for Identification and Estimation of Nonlinear Production Functions}
\author{Justin Doty\thanks{Department of Economics, University of Iowa, S321 Pappajohn Business Building, 21 E Market St, Iowa City, IA 52242. Email: \texttt{justin-doty@uiowa.edu}} and Suyong Song\thanks{Department of Economics and Finance, University of Iowa, W360 Pappajohn Business Building, 21 E Market St, Iowa City, IA 52242. Email: \texttt{suyong-song@uiowa.edu}}
}
\date{\vspace{-5ex}}
\begin{document}
\maketitle{} 
\section{Introduction}

Consider a nonlinear model for a firm's gross-output production function
\begin{equation}\label{modely}
Y_{it}=\sum_{k=1}^{K_{1}}\beta_{k}(\eta_{it})g_{k}(L_{it}, M_{it}, K_{it}, \omega_{it})
\end{equation}
where $Y_{it}$ is firm $i$'s' output at time $t$ and $L_{it}, M_{it}, K_{it}$ denotes optimal input choices for labor, materials, and capital respectively. The unobserved productivity is denoted by $\omega_{it}$ which is correlated to input choices of the firm at time $t$. We let the output elasticities $\beta$ to be functionally dependent on unobserved production shocks $\eta_{i1},\dots, \eta_{iT}$ that are uncorrelated to input choices and productivity at time $t$.\\

Without loss of generality we normalize $\eta_{it}$ to be uniformly distributed on the interval $[0,1]$. This model corresponds to a nonlinear random coefficient model where the outcome $y_{it}$ is monotonic in $\eta_{it}$. In practice we can allow for nonlinear interactions between inputs and unobserved productivity at different quantiles so that marginal effects can be modeled as non-Hick's neutral. For empirical simplicity we can model separability in the unobserved productivity to calculate total factor productivity (TFP). The function $g$ is an unknown nonlinear function.

In this model, heterogeneity in production technology across firms is driven by the rank of the unobserved production shocks $\eta_{it}$. We specify the productivity process as
\begin{equation}\label{modelw}
\omega_{it}=\sum_{k=1}^{K_{2}}\rho_{k}(\xi_{it})h_{k}(\omega_{it-1})
\end{equation}

where $\xi_{i1},\dots, \xi_{iT}$ are independent uniform random variables which represent innovation shocks to productivity. We assume $\omega_{it}$ is monotonic in $\xi_{it}$ We let $h$ be another unknown nonlinear function that allows the persistence in productivity in firms to be nonlinear across different quantiles.

%-----------------------------------------------------------------------------------------------------
\section{Econometric Model}

We introduce a dynamic model of firm investment that is a slight modification of \cite{Ericson1995}. We begin by providing the evolution process for $\omega_{t}\in \mathbbm{R}$ which is given by:

\begin{equation} \label{ar1}
\omega_{t}=g(\omega_{t-1}, \xi_{t}),
\end{equation}
where the function $g(\cdot, \xi_{t})$ is strictly increasing in the iid innovation shock, $\xi_{t}\in \mathbbm{R}$. The exogeneity of the productivity process can be relaxed when we consider productivity enhancing activities such as R\&D similar to \cite{Doraszelski2013}.\\

Capital accumulates according to the following process:

\begin{equation} \label{kaccum}
K_{t}=\kappa_{t}(K_{t-1}, I_{t-1}, \upsilon_{t}),
\end{equation}
where the function $\kappa$ is strictly increasing in its last argument and $\upsilon_{t}$ denotes an iid shock independent of the other arguments. A special case of equation \eqref{kaccum} is the usual capital accumulation law $K_{t}=(1-\delta)K_{t-1}+I_{t-1}+\upsilon_{t}$. Here $\upsilon_{t}$ are other factors that affect the capital accumulation process. Breaking this deterministic relationship in the capital accumulation process allows for variation in investment $I_{t}$ conditional on $K_{t+1}$ and $K_{t}$ which will be important in the identification results in the next section. 

The investment decision problem is an extension of the \cite{Ericson1995} framework which can also be found in \cite{Hu2013} and \cite{Ackerberg2007}. In each period, a firm chooses investment to maximize its discounted future profits:
\begin{equation} \label{valuefn}
I_{t}=I^{*}(K_{t}, \omega_{t}, \zeta_{t})=\underset{I_{t}\geq 0}{\operatorname{argmax}}\Bigg[\Pi_{t}(K_{t}, \omega_{t}, \zeta_{it})-c(I_{t})+\beta\mathbbm{E}\big[V_{t+1}(K_{t+1}, \omega_{t+1}, \zeta_{t+1})|\mathcal{I}_{t}\big]\Bigg],
\end{equation}
where $\pi_{t}(\cdot)$ is current period profits as a function of the state variables and an unobservable demand shock $\zeta_{it}$. These are shocks to a firm's product demand which are privately observed by each firm and i.i.d across $i$ and $t$. We assume these shocks are independent from the firm's state variables. Current costs to investment are given by $c(I_{t})$ and $\beta$ is the firm's discount factor. \cite{Pakesa} provides specific conditions for which the investment policy function is strictly increasing in its scalar unobservable component. However, the difference here is that we require the condition to be on the unobservable demand shock, as opposed to the unobserved productivity shock, $\omega_{it}$. We require that the firm's individual demand function is strictly increasing in $\zeta_{it}$ which is required in the quantile regression literature for demand functions, see for example \citep{Blundell2017} regarding non-separable demand functions.\textcolor{red}{We can interpret conditions for strict monotonicity here and leave a detailed explanation in the appendix.} Without loss of generality, we normalize $\zeta_{t}\sim U[0,1]$. In a later section we show how to modify identification and estimation strategies to cases when investment is censored or there is selection bias due to endogenous entry/exit which can be the case in certain industries.

The specifications for the static inputs, labor and material are much easier to state. We let optimal labor demand be given by:
\begin{equation} \label{labordemand}
l_{t}=\ell(k_{t}, \omega_{t}, \epsilon_{t})
\end{equation}
where the function, $\ell(\cdot, \cdot, \epsilon_{t})$ is strictly increasing in $\epsilon_{t}$ which is assumed to be independent of the other arguments. We normalize this to be standard uniform each period. We follow a similar model for materials:
\begin{equation} \label{matdemand}
m_{t}=m_{t}(k_{t}, \omega_{t}, \varepsilon_{t})
\end{equation}
where the function, $m(\cdot, \cdot, \varepsilon_{t})$ is strictly increasing in $\varepsilon_{t}$ which is assumed to be independent of the other arguments. We normalize this to be standard uniform each period.

%-----------------------------------------------------------------------------------------------------------

\section{Identification}

Our goal is identification of the Markov law of motion $f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t} \omega_{t}|Y_{t-1}, L_{t-1}, M_{t-1}, K_{t-1}, I_{t-1} \omega_{t-1}}$ which we allow to be stationary. We assume the researcher observes a panel dataset consisting of i.i.d observations of firm output and input choices with the number of time periods $T\geq 4$ for a large number of firms. We introduce the following assumptions that simplify the expression for the law of motion. 

\begin{assump}(Production Dynamics)\label{markovfeedback}
~
    \begin{enumerate}
        \item \textit{Non-dynamic output and inputs:} $f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|Y_{t-1}, L_{t-1}, M_{t-1}, K_{t-1}, I_{t-1} \omega_{t-1}}=f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t} \omega_{t}|K_{t-1}, I_{t-1} \omega_{t-1}}$
        \item \textit{First-order Markov:} $f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t} \omega_{t}|K_{t-1}, I_{t-1} \omega_{t-1}, \mathcal{I}_{<t-1}}=f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t} \omega_{t}|K_{t-1}, I_{t-1} \omega_{t-1}}$, where $\mathcal{I}_{<t-1}$ is the firm's information set up to time $t-1$
        \item \textit{Limited Feedback:} $f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}|K_{t-1}, I_{t-1}, \omega_{t}, \omega_{t-1}}=f_{Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}|K_{t-1}, I_{t-1}, \omega_{t}}$ 
        \item \textcolor{red}{\textit{Mutual Independence:} $\eta_{t}, \epsilon_{t}, \varepsilon_{t}$ and $\zeta_{t}$ are mutually independent conditional on $K_{t}$ and $\omega_{t}$}
    \end{enumerate}
\end{assump}

Assumption \eqref{markovfeedback}(1) states that input decisions for labor and material inputs maximize profits in the current period and do not have any dynamic implications. This can be relaxed to include cases where labor has dynamic effects due to hiring/firing costs. This assumption also does not allow for dynamic effects of output, which is standard in the production function literature. Assumption \eqref{markovfeedback}(2) is a standard condition in Markovian dynamic decision models. Decision and state variables any period before the previous period are irrelevant to the firm given the information contained in last periods decision and state variables. The investment model we introduce in the next few paragraphs satisfies this assumption and is trivially satisfied for any of the static decision variables.\\

Assumption \eqref{markovfeedback}(3) states that previous period's productivity does not directly affect the firms decision and state variables in the current period. Instead, they indirectly affect these variables through the previous periods decision and state variables. \textcolor{red}{Assumption \eqref{markovfeedback}(4) are conditional independence assumptions for output and the flexible input decisions. Conditional on current period labor, materials, and capital, the previous period's capital as well as investment are not relevant in determining output in the current period. Also, capital summarizes the information about investment relevant in determining labor, but also assumes that labor decisions are mutually independent of material input decisions. The latter assumption is satisfied using timing assumptions that are common in the literature.}

We will proceed in steps in factoring the Markov law of motion into the densities we are interested in identying. First, using Assumption \eqref{markovfeedback} 1 and 2:
\begin{equation} \label{markovfactor}
    \begin{split}
        &f(Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|Y_{t-1}, L_{t-1}, M_{t-1}, K_{t-1}, I_{t-1}, \omega_{t-1}, \mathcal{I}_{<t-1})\\
        &=f(Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})
    \end{split}
\end{equation} 
We can simplify the density on the last line of the equation \eqref{markovfactor} as
\begin{equation} \label{1stdensity}
\begin{split}
&f(Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})\\
&=f(Y_{t}|L_{t}, M_{t}, K_{t}, K_{t-1}, I_{t}, I_{t-1}, \omega_{t}, \omega_{t-1})f(L_{t}|M_{t}, K_{t}, K_{t-1}, I_{t}, I_{t-1}, \omega_{t}, \omega_{t-1})\\
&\times f(M_{t}|K_{t}, K_{t-1}, I_{t}, I_{t-1}, \omega_{t}, \omega_{t-1})f(K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})
\end{split}
\end{equation}
Using Assumption \eqref{markovfeedback} 3 and 4, equation \eqref{1stdensity} becomes
\begin{equation} \label{2nddensity}
    \begin{split}
        &f(Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})\\
        &=f(Y_{t}|L_{t}, M_{t}, K_{t}, \omega_{t})f(L_{t}|K_{t}, \omega_{t})f(M_{t}|K_{t}, \omega_{t})f(K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})
    \end{split}
\end{equation} 

The last density on the second line of equation \eqref{2nddensity} is the Markov law of motion for capital, investment, and productivity. It can be factored as:
\begin{equation} \label{3rddensity}
    \begin{split}
        &f(K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})\\
        &=f(I_{t}|K_{t}, K_{t-1}, I_{t-1}, \omega_{t}, \omega_{t-1})f(K_{t}|I_{t-1}, K_{t-1}, \omega_{t-1})f(\omega_{t}|K_{t}, K_{t-1}, \omega_{t-1})\\
        &=f(I_{t}|K_{t}, \omega_{t})f(K_{t}|K_{t-1}, I_{t-1})f(\omega_{t}|\omega_{t-1})
    \end{split}
\end{equation} 
The last line of equation \eqref{3rddensity} uses a combination of Assumption \eqref{markovfeedback} 3 and the way investment, capital, and the productivity process in the previous section.  

Combining all of the above assumptions, the density we are interested in identifying is:

\small
\begin{equation}
f(Y_{t}, L_{t}, M_{t}, K_{t}, I_{t}, \omega_{t}|K_{t-1}, I_{t-1}, \omega_{t-1})=f(Y_{t}|L_{t}, M_{t}, K_{t}, \omega_{t})f(L_{t}|K_{t}, \omega_{t})f(M_{t}|K_{t}, \omega_{t})f(I_{t}|K_{t}, \omega_{t})f(K_{t}|K_{t-1}, I_{t-1})f(\omega_{t}|\omega_{t-1})
\end{equation}

%---------------------------------------------------------------------------------------------------------

\subsection{Hu and Shum (2012) Identification}

\textcolor{red}{STILL A WORK IN PROGRESS, THESE DO NOT REFLECT MOST RECENT CHANGES ABOVE}

We outline the identification procedure similar to \cite{Hu2012}. First, let $V_{t}=\{X_{t}, W_{t}\}$. Under assumption \eqref{markovfeedback}, we can write:
 \begin{equation}\label{obsdens}
 f_{X_{t+1}, W_{t+1}, X_{t}, W_{t}, X_{t-1}, W_{t-1}, X_{t-2}, W_{t-2}}=\int f_{X_{t+1},W_{t+1}|W_{t},\omega_{t}}f_{X_{t}, W_{t}|W_{t-1},\omega_{t}}f_{X_{t-1}, W_{t-1}, X_{t-2}, W_{t-2}, \omega_{t}}d\omega_{t}
 \end{equation}
 \textcolor{red}{Should this be factored further?}

The linear operator $L_{V_{t-2},\bar{x}_{t-1},\bar{w}_{t-1},\bar{x}_{t},\bar{w}_{t}, V_{t+1}}$ as a mapping from the $\mathcal{L}^{p}$ space of functions of $V_{t+1}$ to the $\mathcal{L}^{p}$ space of functions of $V_{t-2}$ is defined as

\begin{equation}\label{operator}
    \begin{split}
     (&L_{V_{t-2},\bar{x}_{t-1},\bar{w}_{t-1},\bar{x}_{t},\bar{w}_{t}, V_{t+1}}h)(v_{t-2})\\
     &=\int f_{V_{t-2}, X_{t-1}, W_{t-1}, X_{t}, W_{t}, V_{t+1}}(v_{t-2}, \bar{x}_{t-1}, \bar{w}_{t-1}, \bar{x}_{t}, \bar{w}_{t}, v_{t+1})h(v_{t+1})dv_{t+1}:\\
     &h\in \mathcal{L}^{p}(\mathcal{V}_{t+1}), \bar{x}_{t-1}\in \mathcal{X}_{t-1}, \bar{x}_{t}\in \mathcal{X}_{t}, \bar{w}_{t-1}\in \mathcal{W}_{t-1}, \bar{w}_{t}\in \mathcal{W}_{t},
    \end{split}
\end{equation}
where $\mathcal{V}_{t}, \mathcal{X}_{t-1}, \mathcal{X}_{t}, \mathcal{W}_{t-1}$ and $\mathcal{W}_{t}$ are the supports of $V_{t}, X_{t-1}, X_{t}, W_{t-1}$ and $W_{t}$ respectively. We also define the diagonal operator as:
\begin{equation}\label{diagonal}
    \begin{split}
        (D_{\bar{x}_{t}, \bar{w}_{t}|\bar{w}_{t-1}, \omega_{t}}h)(\omega_{t})&=f_{X_{t}, W_{t}|, W_{t-1}, \omega_{t}}(\bar{x}_{t}, \bar{w}_{t}|\bar{w}_{t-1}, \omega_{t})h(\omega_{t})\\
        &h\in \mathcal{L}^{p}(\Omega_{t}), \bar{x}_{t}\in \mathcal{X}_{t}, \bar{w}_{t}\in \mathcal{W}_{t}, \bar{w}_{t-1}\in \mathcal{W}_{t-1}
    \end{split}
\end{equation}
We provide a few lemmas that allow us to represent the observed density $f_{X_{t+1}, W_{t+1}, X_{t}, W_{t}, X_{t-1}, W_{t-1}, X_{t-2}, W_{t-2}}$ and the Markov law of motion $f_{X_{t}, W_{t}, \omega_{t}|X_{t-1}, W_{t-1}, \omega_{t-1}}$ using operator notation.

\begin{lemma} (Representation of the Observed Density)
~
For any $t\in\{3,\dots, T-1\}$. Assumption \eqref{markovfeedback} implies that, for any $(x_{t}, w_{t}, x_{t-1}, w_{t-1})\in \mathcal{X}_{t}\times \mathcal{W}_{t}\times \mathcal{X}_{t-1}\times \mathcal{W}_{t-1}$,
\begin{equation}\label{obsoperator}
L_{V_{t+1},x_{t}, w_{t}, x_{t-1}, w_{t-1}}=L_{V_{t+1}|w_{t}, \omega_{t}}D_{x_{t}, w_{t}|w_{t-1}, \omega_{t}}L_{x_{t-1}, w_{t-1}, V_{t-2}, \omega_{t}}
\end{equation}
\end{lemma}

\begin{lemma} (Representation of the Markov Law of Motion)
~
For any $t\in\{3,\dots, T-1\}$ and under certain invertibility conditions provided below give, for any $(x_{t}, w_{t}, x_{t-1}, w_{t-1})\in \mathcal{X}_{t}\times \mathcal{W}_{t}\times \mathcal{X}_{t-1}\times \mathcal{W}_{t-1}$,
\begin{equation}\label{markovoperator}
L_{x_{t},w_{t},\omega_{t}|w_{t-1},\omega_{t-1}}=L^{-1}_{V_{t+1}|w_{t},\omega_{t}}L_{V_{t+1},x_{t},w_{t},x_{t-1}, w_{t-1}, V_{t-2}}L^{-1}_{V_{t},x_{t-1},w_{t-1},V_{t-2}}L_{V_{t}|w_{t-1},\omega_{t}}
\end{equation}
\end{lemma}

The identification argument then depends on the existence and uniqueness a spectral decomposition of the linear operator $L_{V_{t+1},x_{t}, w_{t}, x_{t-1}, w_{t-1}}$ which corresponds to the observed density $f_{X_{t+1}, W_{t+1}, X_{t}, W_{t}, X_{t-1}, W_{t-1}, X_{t-2}, W_{t-2}}$. We state these assumptions and their interpretation in the production function literature and in context of our model.

\begin{assump}(Invertibility)
~
There exists variable(s) $V_{t}$ such that
    \begin{enumerate}[label=\alph*)]
    \item For any $w_{t}\in \mathcal{W}_{t}$, $L_{V_{t+1}|w_{t}, \omega_{t}}$ is one-to-one
    \item For any $(x_{t-1}, w_{t-1})\in \mathcal{X}_{t-1}\times\mathcal{W}_{t-1}$, $L_{V_{t}, x_{t-1}, w_{t-1}, V_{t-2}}$ is one-to-one
    \item For any $(x_{t}, w_{t})\in \mathcal{X}_{t}\times\mathcal{W}_{t}$, there exists a $(x_{t-1}, w_{t-1})\in \mathcal{X}_{t-1}\times\mathcal{W}_{t-1}$ and a neighborhood $\mathcal{N}^{r}$ around $(x_{t}, w_{t}, x_{t-1}, w_{t-1})$ such that, for any $(\bar{x}_{t}, \bar{w}_{t}, \bar{x}_{t-1}, \bar{w}_{t-1})\in \mathcal{N}^{r}$, $L_{V_{t-2}, \bar{x}_{t}, \bar{w}_{t}, \bar{x}_{t-1}, \bar{w}_{t-1}, V_{t-2}}$ is one-to-one
    \end{enumerate}
\end{assump}


%----------------------------------------------------------------------------------------------------------

\section{Estimation Strategy}

Our empirical specification for the Markovian transitions of productivity, output, and capital evolution closely resemble \cite{Arellano2017}. Let $z_{it}=(l_{it}, m_{it})$ denote the flexible input choices for notational simplicity.

\subsection{Persistent Productivity}
Let $age_{it}$ denote the age of firm $i$ at time $t$, we specify productivity to transition according to:
\begin{equation}\label{omegamodel}
Q_{t}(\omega_{it-1}, \tau)=Q(\omega_{it-1}, age_{it}, \tau)=\sum_{k=1}^{K}\rho_{k}(\tau)g_{k}(\omega_{it-1}, age_{it})
\end{equation}

\noindent The quantile function for $\omega_{i1}$ is specified in a similar way
\begin{equation}
\label{omega1model}
Q_{\omega_{1}}(age_{i1}, \tau)=\sum_{k=0}^{K}\rho_{k}^{1}(\tau)g_{k}(age_{i1})
\end{equation}

\subsection{Output}
We specify the output equation as follows:
\begin{equation}\label{ymodel}
\begin{split}
Q_{t}(z_{it}, k_{it} \omega_{it}, \tau)&=Q(z_{it}, k_{it}, age_{it}, \omega_{it}, \tau)\\
&=\sum_{k=1}^{K}\beta_{k}g_{k}(z_{it}, k_{it}, age_{it}, \omega_{it})+\beta_{0}(\tau)
\end{split}
\end{equation}

\subsection{Investment Demand}
We specify the investment demand equation as:
\begin{equation}\label{imodel}
\begin{split}
\iota_{t}(\omega_{it}, k_{it}, \tau)&=\iota(\omega_{it}, k_{it}, age_{it}, \tau)\\
&=\sum_{k=1}^{K}\iota_{k}g_{k}(\omega_{it}, k_{it}, age_{it})+\iota_{0}(\tau)
\end{split}
\end{equation}

\subsection{Capital}
We specify the distribution of initial capital as:
\begin{equation}\label{kinitial}
Q_{\kappa}(\omega_{i1}, age_{i1}, \tau)=\sum_{k=0}^{K}\kappa_{k}^{1}g_{k}(\omega_{i1}, age_{i1})
\end{equation}
The evolution of capital is specified as:
\begin{equation}\label{kevolution}
\begin{split}
\kappa_{t}(\omega_{it}, K_{it-1}, I_{it-1}, \tau)&=\kappa_{t}(\omega_{it}, K_{it-1}, I_{it-1}, age_{it}, \tau)\\
&=\sum_{k=1}^{K}\kappa_{k}g_{k}(\omega_{it}, K_{it-1}, I_{it-1}, age_{it})+\kappa_{0}(\tau)
\end{split}
\end{equation}

\subsection{Static Inputs}
Finally, we specify a reduced-form demand function for the static inputs of $z=(m, l, u)$ (in logs) as:
\begin{equation}\label{staticmodel}
\begin{split}
\mu_{t}^{z}(k_{it}, \omega_{it}, \tau)&=\mu^{z}(k_{it}, \omega_{it}, age_{it}, \tau)\\
&=\sum_{k=1}^{K}\mu_{zk}g_{k}(\omega_{it}, k_{it}, age_{it})+\mu_{z0}(\tau)
\end{split}
\end{equation}

\section{Implementation}
To ease notation, we let $\rho_{k}, \rho_{k}, \beta_{0}, \iota_{0}, \kappa_{0}, \mu_{z0}$ be indexed by a finite dimensional parameter vector $\theta$ that also contains $\beta_{1},\dots,\beta_{K}, \iota_{1},\dots,\iota_{K}, \kappa_{1},\dots, \kappa_{K}$ and $ \mu_{z1},\dots,\mu_{zK}$. We model the functional parameters using \cite{Wei2009} and \cite{Arellano2016}. For example, the function $\rho_{\omega}$ is modeled as a piecewise-polynomial interpolating splines on a grid $[\tau_{1},\tau_{2}], [\tau_{3},\tau_{4}],\dots, [\tau_{J-1},\tau_{J}]$, contained in the unit interval and is constant on $[0, \tau_{1}]$ and $[\tau_{J}, 1)$ The intercept coefficient $\rho_{0}$ is specified as the quantile of an exponential distribution on $(0,\tau_{1}]$ (indexed by $\lambda_{\omega}^{-}$) and $[\tau_{J-1}, 1)$ (indexed by $\lambda_{\omega}^{+}$).\\

The function $\rho_{\omega}$ is modeled as piecewise linear on $[\tau_{1}, \tau_{J}]$.The remaining functional parameters are modeled similarly. We take $J=11$ and $\tau_{j}=\frac{j}{J+1}$. Following \cite{Arellano2017} we parameterize the distribution of $\eta$ to be log-normal so we set, for example, $\beta_{0}(\tau)=\alpha_{0}+\sigma\Phi^{-1}(\tau)$. Similar parameterizations for made for $\iota_{0}, \kappa_{0}$ and $\mu_{z0}$.  In the following section we outline the model's restrictions and a feasible estimation strategy.

\subsection{Model Restrictions}
Let $\Psi_{\tau}(u)=\tau-\mathbbm{1}\{u<0\}$ denote the first derivative of the quantile check function $\psi_{\tau}(u)=(\tau-\mathbbm{1}\{u<0\})u$. The following conditional moment restrictions hold as an implication of the conditional independence restrictions in section 2. Therefore, we estimate the parameters of interest from the following conditional moment restrictions. For $t\geq 2$

\begin{equation}\label{omegaqmoment}
\mathbbm{E}\Bigg[\Psi_{\tau_{j}}(\xi_{it})\Big|\omega_{it-1}, age_{it}\Bigg]=0
\end{equation}
For initial productivity,
\begin{equation}\label{omega1qmoment}
\mathbbm{E}\Bigg[\Psi_{\tau_{j}}(\xi_{i1})\Big|\omega_{i1}, age_{i1}\Bigg]=0
\end{equation}
and for initial capital
\begin{equation}\label{k1qmoment}
\mathbbm{E}\Bigg[\Psi_{\tau_{j}}(\upsilon_{i1})\Big|\omega_{i1}, age_{i1}\Bigg]=0
\end{equation}
For the nonlinear specifications we have
\begin{equation}\label{yemoment}
\mathbbm{E}\Bigg[\eta_{it}\Big|\omega_{it}, z_{it}, k_{it}, age_{it}\Bigg]=0
\end{equation}
\begin{equation}\label{iemoment}
\mathbbm{E}\Bigg[\zeta_{it}\Big|\omega_{it}, k_{it}, age_{it}\Bigg]=0
\end{equation}
\begin{equation}\label{kemoment}
\mathbbm{E}\Bigg[\upsilon_{it}\Big|\omega_{it}, K_{it-1}, I_{it-1},  age_{it}\Bigg]=0
\end{equation}
\begin{equation}\label{emoment}
\mathbbm{E}\Bigg[\varepsilon^{Z}_{it}\Big|\omega_{it}, k_{it}, age_{it}\Bigg]=0
\end{equation}

To fix ideas, we first specify how to estimate the conditional moments for persistent productivity and production.\\

\noindent For $t\geq 2$
\begin{equation}\label{omegamoment}
\begin{split}
\mathbbm{E}\Bigg[&\Psi_{\tau_{j}}(\xi_{it})\Big|\omega_{it-1}, age_{it}\Bigg]=\\
&\mathbbm{E}\Bigg[\Psi_{\tau_{j}}(\omega_{it}-\sum_{k=1}^{K}\bar{\rho}_{k}(\tau_{j})g_{k}(\omega_{it-1}, age_{it}))\Big|\omega_{it-1}, age_{it}\Bigg]=0
\end{split}
\end{equation}

\begin{equation}\label{ymoment}
\begin{split}
\mathbbm{E}\Bigg[&\eta_{it}\Big|\omega_{it}, z_{it}, k_{it}, age_{it}\Bigg]=\\
&\mathbbm{E}\Bigg[(y_{it}-\bar{\alpha}-\sum_{k=1}^{K}\bar{\beta}_{k}g_{k}(z_{it}, k_{it}, \omega_{it}, age_{it}))\Big|\omega_{it}, z_{it}, k_{it}, age_{it}\Bigg]=0
\end{split}
\end{equation}

Here $\bar{\rho}_{k}(\tau_{j}), \bar{\beta}_{k}$ and $\bar{\alpha}$ denote the true values of $\rho_{k}(\tau_{j}), \beta_{k}$ and $\alpha$ for $j\in\{1,\dots, J\}$ and $k\in\{1,\dots,K\}$. Clearly, estimating the above conditional moment restrictions are infeasible due to the unobserved productivity component. Therefore, we use the following unconditional moment restrictions and posterior distributions for $\omega_{it}$ to integrate out the unobserved productivity. Due to the law of iterated expectations we now have the following integrated moment conditions:

\begin{equation}\label{omegaimc}
\mathbbm{E}\Bigg[\int\Bigg(\Psi_{\tau_{j}}(\omega_{it}-\sum_{k=1}^{K}\bar{\rho}_{k}(\tau_{j})g_{k}(\omega_{it-1}, age_{it}))\otimes
\begin{pmatrix}
1 \\
\omega_{it-1}\\
age_{it}
\end{pmatrix}
\Bigg)g_{i}(\omega_{it};\bar{\theta})d\omega_{it}\Bigg]=0
\end{equation}
and 
\begin{equation}\label{yimc}
\begin{split}
\mathbbm{E}\Bigg[\int\Bigg((y_{it}&-\bar{\alpha}-\sum_{k=1}^{K}\bar{\beta}_{k}g_{k}(z_{it}, k_{it}, \omega_{it},age_{it}))\otimes
\begin{pmatrix}
1 \\
\omega_{it}\\
z_{it}\\
k_{it}\\
age_{it}
\end{pmatrix}
\Bigg)g_{i}(\omega_{it};,\bar{\theta})d\omega_{it}\Bigg]=0,
\end{split}
\end{equation}

where $\bar{\theta}$ denotes the true values of $\theta$. The posterior distribution is specified as (age omitted for ease of notation):
\begin{equation}\label{posterior}
\begin{split}
f_{i}(\omega_{it};\bar{\theta})&=f(\omega_{it}|y_{it}, z_{it}, k_{it}, I_{it}; \bar{\theta}) \propto\\
&\prod_{t=1}^{T}f(y_{it}|\omega_{it}, z_{it}, k_{it};\bar{\theta})\times
\prod_{t=1}^{T}f(z_{it}|\omega_{it}, k_{it};\bar{\theta})\times\\
&\prod_{t=2}^{T}f(K_{it}|\omega_{it}, K_{it-1}, I_{it-1};\bar{\theta})\times \prod_{t=1}^{T}f(I_{it}|\omega_{it}, k_{it}; \bar{\theta})\times \\
&\prod_{t=2}^{T}f(\omega_{it}|\omega_{it-1};\bar{\theta})\times f(\omega_{i1};\bar{\theta})\times f(K_{i1}|\omega_{i1};\bar{\theta})
\end{split}
\end{equation}

The posterior density in equation \eqref{posterior} is a closed-form expression when using piece-wise linear splines for $\theta(\cdot)$. The estimation is an Expectation Maximization (EM) algorithm. In \cite{Arellano2016} and \cite{Arellano2017}, the ``M-step'' is performed using quantile regression. Given an initial parameter value $\hat{\theta}^{0}$. Iterate on $s=0,1,2,\dots$ in the following two-step procedure until converge to a stationary distribution:

\begin{enumerate}
    \item \textit{Stochastic E-Step}: Draw $M$ values $\omega_{i}^{(m)}=(\omega_{i1}^{(m)}, \omega_{i2}^{(m)},\dots, \omega_{iT}^{(m)})$ from
        \begin{equation*}
        \begin{split}
            f_{i}(\omega_{it};,\hat{\theta}^{(s)})&=f(\omega_{it}|y_{it}, z_{it}, k_{it}, I_{it}; \hat{\theta}^{(s)}) \propto\\
            &\prod_{t=1}^{T}f(y_{it}|\omega_{it}, z_{it}, k_{it};\hat{\theta}^{(s)})\times
            \prod_{t=1}^{T}f(z_{it}|\omega_{it}, k_{it};\hat{\theta}^{(s)})\times\\
            &\prod_{t=2}^{T}f(K_{it}|\omega_{it}, K_{it-1}, I_{it-1};\hat{\theta}^{(s)})\times \prod_{t=1}^{T}f(I_{it}|\omega_{it}, k_{it}; \hat{\theta}^{(s)})\times \\
            &\prod_{t=2}^{T}f(\omega_{it}|\omega_{it-1};\hat{\theta}^{(s)})\times f(\omega_{i1};\hat{\theta}^{(s)})\times f(K_{i1}|\omega_{i1};\hat{\theta}^{(s)})
            \end{split}
        \end{equation*}
    \item \textit{Maximization Step}: For $j=1,\dots, J$, solve
    \begin{equation*}
    \begin{split}
    \hat{\boldsymbol\rho}(\tau_{j})^{(s+1)}&=\underset{\boldsymbol\rho(\tau_{j})}{\operatorname{argmin}}\,\sum_{i=1}^{N}\sum_{t=2}^{T}\sum_{m=1}^{M}\Psi_{\tau_{j}}(\omega_{it}^{(m)}-\sum_{k=1}^{K}\rho_{k}g_{k}(\omega_{it-1}^{(m)}, age_{it}))\\
    \hat{\boldsymbol\rho^{1}}(\tau_{j})^{(s+1)}&=\underset{\boldsymbol\rho^{1}(\tau_{j})}{\operatorname{argmin}}\,\sum_{i=1}^{N}\sum_{m=1}^{M}\Psi_{\tau_{j}}(\omega_{i1}^{(m)}-\sum_{k=1}^{K}\rho_{k}^{1}g_{k}(age_{i1}))\\
    \hat{\boldsymbol\kappa^{1}}(\tau_{j})^{(s+1)}&=\underset{\boldsymbol\kappa^{1}(\tau_{j})}{\operatorname{argmin}}\,\sum_{i=1}^{N}\sum_{m=1}^{M}\Psi_{\tau_{j}}(K_{i1}-\sum_{k=1}^{K}\kappa_{k}^{1}g_{k}(\omega_{i1}^{(m)}, age_{i1}))\\
    \end{split}
    \end{equation*}
    
    The parameters of the production function equation in \eqref{yimc} can be estimated using a nonlinear regression for a given draw of $\omega_{it}^{(m)}$. Then, the variance of the shock $\eta$ can be estimated using \footnote{The parameters of the investment equation, capital accumulation process, and static inputs can be estimated similarily, however are omitted for clarity. See appendix for details.}
     \begin{equation}\label{staticyvar}
     \hat{\sigma}^{2}=\frac{1}{NTM}\sum_{t=1}^{T}\sum_{i=1}^{N}\sum_{m=1}^{M}\Bigg[\Bigg(y_{it}-\hat{\alpha}-\sum_{k=1}^{K}\hat{\beta}_{k}g_{k}(\omega_{it}^{(m)}, z_{it}, k_{it}, age_{it})\Bigg)^{2}\Bigg]
     \end{equation}
\end{enumerate}

\pagebreak
\newpage

\bibliographystyle{ecca.bst}
\bibliography{NL_PF_QR}


\end{document}